/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a user-ownership model for inquiries and their messages.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information. Document ID matches the Firebase Auth UID.
 * - /inquiries/{inquiryId}: Stores customer service inquiries. Each inquiry has a userId indicating ownership.
 * - /inquiries/{inquiryId}/messages/{messageId}: Stores the chat log for a specific inquiry.
 *
 * Key Security Decisions:
 * - Users can only create, read, update, and delete their own inquiries.
 * - Anyone who is signed in can create, read, update and delete messages within inquiries.
 *
 * Denormalization for Authorization:
 * - The Inquiry document has a userId field to simplify ownership checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows access to messages within an inquiry to anyone who is signed in.
     * @path /inquiries/{inquiryId}/messages/{messageId}
     * @allow (read, write): Any authenticated user can read and write messages.
     * @deny (none): No requests are explicitly denied.
     * @principle Allows any signed in user to perform any operation.
     */
    match /inquiries/{inquiryId}/messages/{messageId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
  }

  /**
   * @description Checks if the user is signed in.
   * @return True if request.auth is not null, false otherwise.
   */
  function isSignedIn() {
    return request.auth != null;
  }
}